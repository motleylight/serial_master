# Search åŠŸèƒ½è®¾è®¡ä¸å®ç°è®¡åˆ’

ä¸ºä¸²å£å·¥å…·æ·»åŠ  Searchï¼ˆæœç´¢ï¼‰åŠŸèƒ½ï¼Œä¸ç°æœ‰ Filterï¼ˆè¿‡æ»¤ï¼‰åŠŸèƒ½å…±å­˜ã€‚

## åŠŸèƒ½å¯¹æ¯”

| ç‰¹æ€§ | Filter (è¿‡æ»¤) | Search (æœç´¢) |
|------|--------------|---------------|
| **æ˜¾ç¤ºæ–¹å¼** | åªæ˜¾ç¤ºåŒ¹é…è¡Œ + ä¸Šä¸‹æ–‡ | æ˜¾ç¤ºå…¨éƒ¨ï¼Œé«˜äº®åŒ¹é… |
| **æ­£åˆ™è¡¨è¾¾å¼** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **ä¸Šä¸‹æ–‡è¡Œ** | âœ… æ”¯æŒï¼ˆctx=0 æ—¶æ— åˆ†å‰²çº¿ï¼‰ | âŒ ä¸éœ€è¦ |
| **æ›¿æ¢é¢„è§ˆ** | âœ… æ”¯æŒ | âŒ ä¸éœ€è¦ |
| **è·¨è¡ŒåŒ¹é…** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **å¯¼èˆª** | æ—  | âœ… ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ª |

---

## UI è®¾è®¡

### å·¥å…·æ å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ğŸ—‘] [ğŸ’¾] | [HEX] | [ğŸ” Search...          ] [Filterâ–¼] [1/5] [â–²] [â–¼]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’è¯´æ˜ï¼š**

1. **æœç´¢è¾“å…¥æ¡†** - ç»Ÿä¸€çš„è¾“å…¥æ¡†ï¼Œè¾“å…¥å…³é”®å­—
2. **æ¨¡å¼ä¸‹æ‹‰èœå•** - ç‚¹å‡» `[Filterâ–¼]` åˆ‡æ¢æ¨¡å¼ï¼š
   - `Search` - é»˜è®¤æ¨¡å¼ï¼Œé«˜äº®åŒ¹é…ï¼Œå¯å¯¼èˆª
   - `Filter` - è¿‡æ»¤æ¨¡å¼ï¼Œåªæ˜¾ç¤ºåŒ¹é…è¡Œ
3. **åŒ¹é…è®¡æ•°** - æ˜¾ç¤º `å½“å‰/æ€»æ•°`ï¼Œå¦‚ `1/5`
4. **å¯¼èˆªæŒ‰é’®** - `[â–²]` ä¸Šä¸€ä¸ª / `[â–¼]` ä¸‹ä¸€ä¸ª

### æ¢è¡Œç¬¦æç¤º

> [!TIP]
> ç”¨æˆ·åœ¨è·¨è¡ŒåŒ¹é…æ—¶å¯èƒ½ä¸ç¡®å®šä½¿ç”¨ `\n` è¿˜æ˜¯ `\r\n`ï¼Œéœ€è¦æ˜ç¡®æç¤ºã€‚

**è®¾è®¡æ–¹æ¡ˆï¼š**
- **è¾“å…¥æ¡† Placeholder**ï¼š`Regex... (è·¨è¡Œç”¨ \n)`
- **è¾“å…¥æ¡† Tooltip**ï¼š`æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ã€‚è·¨è¡ŒåŒ¹é…ç¤ºä¾‹ï¼šdata.*\n.*end`
- **å¸®åŠ©å›¾æ ‡**ï¼ˆå¯é€‰ï¼‰ï¼šåœ¨è¾“å…¥æ¡†å³ä¾§æ·»åŠ  `?` å›¾æ ‡ï¼Œhover æ˜¾ç¤ºè¯¦ç»†è¯´æ˜

**æŠ€æœ¯å¤„ç†**ï¼šå†…éƒ¨ç»Ÿä¸€å°† `\r\n` å’Œ `\r` è§„èŒƒåŒ–ä¸º `\n`ï¼Œç”¨æˆ·åªéœ€ä½¿ç”¨ `\n` å³å¯åŒ¹é…æ‰€æœ‰æ¢è¡Œã€‚

### Filter æ¨¡å¼æ‰©å±•é¢æ¿

å½“é€‰æ‹© Filter æ¨¡å¼æ—¶ï¼Œæ˜¾ç¤ºé¢å¤–æ§ä»¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ğŸ—‘] [ğŸ’¾] | [HEX] | [ğŸ” Filter...          ] [Filterâ–¼] [5 matches]      â”‚
â”‚                     [Ctx: 2] [Replace: $1  ] [ğŸ”„]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æŠ€æœ¯å®ç°

### çŠ¶æ€è®¾è®¡

```typescript
// æ–°å¢çŠ¶æ€
type SearchMode = 'search' | 'filter';

const [searchMode, setSearchMode] = useState<SearchMode>('search');
const [currentMatchIndex, setCurrentMatchIndex] = useState(0);
const [matchPositions, setMatchPositions] = useState<MatchPosition[]>([]);

interface MatchPosition {
  logIndex: number;      // æ‰€åœ¨æ—¥å¿—æ¡ç›®ç´¢å¼•
  startOffset: number;   // åŒ¹é…èµ·å§‹ä½ç½®ï¼ˆå­—ç¬¦åç§»ï¼‰
  endOffset: number;     // åŒ¹é…ç»“æŸä½ç½®
  isCrossLine?: boolean; // æ˜¯å¦è·¨è¡ŒåŒ¹é…
}
```

### è·¨è¡ŒåŒ¹é…å®ç°æ–¹æ¡ˆï¼ˆæ»‘åŠ¨çª—å£ç®—æ³•ï¼‰

> [!NOTE]
> ä½¿ç”¨æ»‘åŠ¨çª—å£ç®—æ³•å®ç°è·¨è¡ŒåŒ¹é…ï¼Œé¿å…æ‹¼æ¥å®Œæ•´æ–‡æœ¬ï¼Œå†…å­˜æ•ˆç‡æ›´é«˜ã€‚Search å’Œ Filter æ¨¡å¼éƒ½æ”¯æŒè·¨è¡ŒåŒ¹é…ã€‚

**ç®—æ³•åŸç†ï¼š**
- ä½¿ç”¨å›ºå®šå¤§å°çš„æ»‘åŠ¨çª—å£ï¼ˆå¦‚ 5 è¡Œï¼‰
- æ¯æ¬¡æ‹¼æ¥çª—å£å†…çš„è¡Œè¿›è¡ŒåŒ¹é…
- åŒ¹é…æˆåŠŸæ—¶è®°å½•æ¶‰åŠçš„è¡ŒèŒƒå›´

**å®ç°ä»£ç ï¼š**

```typescript
const MAX_CROSS_LINES = 5; // æœ€å¤šè·¨è¶Š 5 è¡Œ

function findCrossLineMatches(
  logs: LogData[], 
  pattern: RegExp
): MatchResult[] {
  const results: MatchResult[] = [];
  const matchedLines = new Set<number>(); // é¿å…é‡å¤æ ‡è®°
  
  for (let start = 0; start < logs.length; start++) {
    // æ„å»ºæ»‘åŠ¨çª—å£æ–‡æœ¬
    let windowText = '';
    const lineRanges: { start: number; end: number }[] = [];
    
    for (let i = start; i < Math.min(start + MAX_CROSS_LINES, logs.length); i++) {
      const lineStart = windowText.length;
      const text = getLogText(logs[i]);
      windowText += text;
      lineRanges.push({ start: lineStart, end: windowText.length });
      
      // å¦‚æœå½“å‰è¡Œå·²æœ‰æ¢è¡Œç¬¦ï¼Œä¸é¢å¤–æ·»åŠ 
      if (!text.endsWith('\n') && !text.endsWith('\r')) {
        windowText += '\n';
      }
    }
    
    // åœ¨çª—å£å†…åŒ¹é…
    pattern.lastIndex = 0;
    let match;
    while ((match = pattern.exec(windowText)) !== null) {
      // ç¡®å®šåŒ¹é…è¦†ç›–çš„è¡ŒèŒƒå›´
      const matchStart = match.index;
      const matchEnd = match.index + match[0].length;
      
      const startLine = lineRanges.findIndex(r => matchStart < r.end);
      const endLine = lineRanges.findIndex(r => matchEnd <= r.end);
      
      if (startLine !== -1) {
        // è®°å½•åŒ¹é…æ¶‰åŠçš„æ‰€æœ‰è¡Œ
        for (let line = start + startLine; line <= start + endLine; line++) {
          if (!matchedLines.has(line)) {
            matchedLines.add(line);
            results.push({
              logIndex: line,
              isPartOfCrossLineMatch: startLine !== endLine,
              matchText: match[0]
            });
          }
        }
      }
      
      // é˜²æ­¢æ— é™å¾ªç¯ï¼ˆé›¶å®½åŒ¹é…ï¼‰
      if (match[0].length === 0) pattern.lastIndex++;
    }
  }
  
  return results;
}
```

**æ€§èƒ½ä¼˜åŠ¿ï¼š**
- å†…å­˜ï¼šO(çª—å£å¤§å°) è€Œé O(æ€»æ—¥å¿—å¤§å°)
- æ—¶é—´ï¼šçº¿æ€§æ‰«æï¼Œæ¯è¡Œæœ€å¤šè¢«è®¿é—® MAX_CROSS_LINES æ¬¡

### é«˜äº®æ¸²æŸ“

ä¿®æ”¹ `LogEntry` ç»„ä»¶ï¼Œæ”¯æŒé«˜äº®æ˜¾ç¤ºåŒ¹é…æ–‡æœ¬ï¼š

```tsx
interface LogEntryProps {
  // ... ç°æœ‰å±æ€§
  highlights?: { start: number; end: number }[];  // éœ€è¦é«˜äº®çš„åŒºé—´
  isCurrentMatch?: boolean;  // æ˜¯å¦æ˜¯å½“å‰å¯¼èˆªåˆ°çš„åŒ¹é…
}

// æ¸²æŸ“æ—¶åˆ†å‰²æ–‡æœ¬å¹¶é«˜äº®
const renderHighlightedText = (text: string, highlights: Highlight[]) => {
  // æŒ‰ highlight åŒºé—´åˆ†å‰²ï¼Œæ·»åŠ  <mark> æ ‡ç­¾
};
```

---

## å®ç°æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ Search æ¨¡å¼

#### [MODIFY] [TerminalContainer.tsx](file:///d:/SerialMaster/src/ui/src/components/Terminal/TerminalContainer.tsx)

1. æ·»åŠ  `searchMode`ã€`currentMatchIndex`ã€`matchPositions` çŠ¶æ€
2. æ·»åŠ æ¨¡å¼åˆ‡æ¢ä¸‹æ‹‰èœå•
3. æ·»åŠ å¯¼èˆªæŒ‰é’®å’ŒåŒ¹é…è®¡æ•°æ˜¾ç¤º
4. æ ¹æ®æ¨¡å¼é€‰æ‹©ä¸åŒçš„æ—¥å¿—å¤„ç†é€»è¾‘

#### [MODIFY] [LogEntry.tsx](file:///d:/SerialMaster/src/ui/src/components/Terminal/LogEntry.tsx)

1. æ·»åŠ  `highlights` å’Œ `isCurrentMatch` props
2. å®ç° `renderHighlightedText` å‡½æ•°
3. æ·»åŠ é«˜äº®æ ·å¼ï¼ˆé»„è‰²èƒŒæ™¯ + å½“å‰åŒ¹é…æ©™è‰²è¾¹æ¡†ï¼‰

---

### ç¬¬äºŒé˜¶æ®µï¼šè·¨è¡ŒåŒ¹é… + å¯¼èˆª

#### [MODIFY] [TerminalContainer.tsx](file:///d:/SerialMaster/src/ui/src/components/Terminal/TerminalContainer.tsx)

1. å®ç° `buildFullTextAndOffsets` å‡½æ•°
2. å®ç°è·¨è¡Œæ­£åˆ™åŒ¹é…é€»è¾‘
3. å®ç° `goToNextMatch` / `goToPrevMatch` å¯¼èˆªå‡½æ•°
4. å¯¼èˆªæ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°å¯¹åº”è¡Œ

---

### ç¬¬ä¸‰é˜¶æ®µï¼šUI ä¼˜åŒ–

1. Filter æ¨¡å¼æ—¶æ˜¾ç¤ºæ‰©å±•æ§ä»¶ï¼ˆä¸Šä¸‹æ–‡è¡Œã€æ›¿æ¢ï¼‰
2. æ·»åŠ é”®ç›˜å¿«æ·é”®ï¼š
   - `F3` / `Enter` - ä¸‹ä¸€ä¸ªåŒ¹é…
   - `Shift+F3` / `Shift+Enter` - ä¸Šä¸€ä¸ªåŒ¹é…
   - `Escape` - æ¸…ç©ºæœç´¢

---

## éªŒè¯è®¡åˆ’

### åŠŸèƒ½æµ‹è¯•

1. **Search æ¨¡å¼**
   - è¾“å…¥å…³é”®å­—ï¼ŒéªŒè¯é«˜äº®æ˜¾ç¤ºæ­£ç¡®
   - ç‚¹å‡»å¯¼èˆªæŒ‰é’®ï¼ŒéªŒè¯æ»šåŠ¨åˆ°å¯¹åº”è¡Œ
   - è¾“å…¥è·¨è¡Œæ­£åˆ™ï¼ŒéªŒè¯åŒ¹é…æ­£ç¡®ï¼ˆå¦‚ `data.*\n.*end`ï¼‰

2. **Filter æ¨¡å¼**
   - éªŒè¯ç°æœ‰åŠŸèƒ½ä¸å—å½±å“
   - éªŒè¯æ¨¡å¼åˆ‡æ¢æ—¶ä¿ç•™æœç´¢è¯

3. **è¾¹ç•Œæƒ…å†µ**
   - ç©ºæœç´¢è¯
   - æ— æ•ˆæ­£åˆ™è¡¨è¾¾å¼
   - å¤§æ•°æ®é‡æ€§èƒ½

### æ‰‹åŠ¨éªŒè¯

- ä½¿ç”¨ä¸²å£å‘é€æµ‹è¯•æ•°æ®ï¼ŒéªŒè¯å®æ—¶æœç´¢å’Œè¿‡æ»¤æ•ˆæœ
