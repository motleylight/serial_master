# SerialMaster 用户指南

SerialMaster 是一款现代化的串口调试工具，基于 Rust 后端 + React 前端构建，提供高性能的串口通信、数据分析和端口共享功能。

---

## 1. 快速开始

### 1.1 连接串口

1. 从**端口选择下拉框**中选择目标串口（如 COM3）
2. 设置**波特率**（默认 115200）
3. 点击绿色的 **"Connect"** 按钮

> **提示**：点击端口下拉框旁的刷新按钮可重新扫描可用端口

### 1.2 查看数据

连接成功后，终端区域会显示接收到的数据：
- **RX**（绿色）：接收的数据
- **TX**（蓝色）：发送的数据
- **SYS**（黄色）：系统消息

### 1.3 发送数据

1. 在底部输入框中输入要发送的内容
2. 点击 **"Send"** 按钮或按 **Enter** 键发送

> **提示**：使用 **↑/↓** 方向键可浏览发送历史

---

## 2. 串口参数配置

### 2.1 基本参数

| 参数 | 选项 | 默认值 |
|------|------|--------|
| 波特率 | 9600, 19200, 38400, 57600, 115200, 230400, 460800, 921600 | 115200 |
| 数据位 | 5, 6, 7, 8 | 8 |
| 停止位 | 1, 2 | 1 |
| 校验位 | None, Odd, Even | None |

点击形如 **"8N1"** 的按钮可打开详细设置面板。

### 2.2 帧分隔超时

**Break (ms)** 参数控制帧分隔超时（默认 10ms）：
- 串口在此时间内没有新数据到达时，认为当前帧结束
- 调小此值可获得更实时的显示
- 调大此值可将连续的数据合并显示

---

## 3. 终端功能

### 3.1 显示模式

点击终端工具栏可切换显示模式：

| 模式 | 说明 |
|------|------|
| **ASCII** | 文本模式，非打印字符显示为 `.` |
| **HEX** | 十六进制模式，如 `48 65 6C 6C 6F` |
| **MIXED** | 混合模式，同时显示 HEX 和 ASCII |

### 3.2 搜索功能

1. 点击搜索图标打开搜索栏
2. 输入搜索内容，按 **Enter** 搜索
3. 使用 **↑/↓** 按钮在匹配结果间跳转

支持的搜索模式：
- **普通文本**：直接输入关键词
- **正则表达式**：点击 `.*` 按钮启用正则模式
- **跨行匹配**：正则模式下自动支持

### 3.3 自动滚动

- 默认开启，新数据到达时自动滚动到底部
- 手动向上滚动或点击日志行会自动关闭
- 点击工具栏的滚动图标可手动切换

### 3.4 日志导出/导入

- **保存**：点击保存图标，将当前日志导出为文本文件
- **加载**：点击打开图标，加载历史日志文件供回放分析

---

## 4. 发送功能

### 4.1 发送模式

点击输入框左侧的 **"HEX"** 开关可切换发送模式：

| 模式 | 输入示例 | 实际发送 |
|------|----------|----------|
| ASCII | `Hello` | `48 65 6C 6C 6F` |
| HEX | `AA BB CC` | `AA BB CC` |

> **注意**：HEX 模式同时会切换终端的显示模式

### 4.2 换行符设置

点击输入框右侧的下拉菜单选择自动追加的换行符：

| 选项 | 追加内容 |
|------|----------|
| None | 不追加 |
| LF | `\n` (0x0A) |
| CR | `\r` (0x0D) |
| CRLF | `\r\n` (0x0D 0x0A) |

---

## 5. 命令管理器

侧边栏的命令管理器用于保存和快速发送常用命令。

### 5.1 基本操作

| 操作 | 方法 |
|------|------|
| 添加命令 | 点击 **"+"** 按钮 |
| 发送命令 | 点击命令行旁的播放按钮 |
| 编辑命令 | 直接在输入框中修改 |
| 删除命令 | 点击垃圾桶图标 |

### 5.2 命令格式

每个命令包含：
- **名称**：显示的标签
- **内容**：实际发送的数据
- **HEX 模式**：是否以十六进制解析内容

### 5.3 命令文件

命令自动保存到 YAML 文件（默认 `commands.yaml`）：

```yaml
- name: 心跳包
  command: "AA BB CC"
  isHex: true

- name: 查询版本
  command: "AT+VERSION?\r\n"
  isHex: false
```

可以手动编辑此文件，或使用工具栏的打开/保存按钮管理多个命令集。

---

## 6. 脚本功能

脚本功能允许对发送/接收的数据进行自动处理。

### 6.1 使用方法

1. 点击工具栏的 **"Script"** 按钮
2. 选择 **TX**（发送前）或 **RX**（接收后）标签
3. 选择脚本类型：
   - **JS**：JavaScript 脚本，无需配置直接运行
   - **External**：调用外部程序（如 Python）
4. 编写脚本内容
5. 点击 **"Run"** 启用

### 6.2 JavaScript 示例

```javascript
// TX Hook：添加校验和
const sum = data.reduce((a, b) => a + b, 0) & 0xFF;
data.push(sum);
```

### 6.3 外部程序示例

命令行配置：
```
python process.py
```

`process.py` 内容：
```python
import sys
data = sys.stdin.buffer.read()
checksum = sum(data) & 0xFF
sys.stdout.buffer.write(data + bytes([checksum]))
```

> **详细说明**：请参阅 [脚本开发指南](SCRIPTING_GUIDE.md)

---

## 7. 端口共享

端口共享功能解决了"一个串口只能被一个软件占用"的限制。

### 7.1 前置条件

需要安装 **com0com** 虚拟串口驱动：
- 下载地址：https://sourceforge.net/projects/com0com/

### 7.2 使用步骤

1. 点击工具栏的 **"Share Port"** 按钮
2. 在弹窗中确认当前物理端口
3. 选择或创建虚拟端口对
4. 点击 **"Start Sharing"**
5. 在第三方软件中连接虚拟端口 A（如 COM10）

### 7.3 工作原理

```
物理设备 ↔ SerialMaster (占用 COM3 + CNCB0) ↔ com0com ↔ 第三方软件 (占用 COM10)
```

- SerialMaster 同时连接物理端口和虚拟端口 B
- com0com 驱动自动将虚拟端口 A ↔ B 的数据互通
- 第三方软件连接虚拟端口 A，像连接真实串口一样操作

### 7.4 状态指示

- 共享激活时，按钮变为**紫色胶囊状态**
- 显示当前暴露的虚拟端口号
- 点击 **"×"** 可快速停止共享

> **详细说明**：请参阅 [端口共享设计](PORT_SHARING_DESIGN.md)

---

## 8. 配置持久化

所有设置自动保存到 `config.yaml`，包括：

| 类别 | 内容 |
|------|------|
| 串口配置 | 端口名、波特率、数据位、停止位、校验位 |
| 终端配置 | 显示模式、自动滚动、自动换行 |
| 发送配置 | HEX 模式、换行符设置 |
| UI 配置 | 侧边栏宽度、显示状态 |
| 脚本配置 | TX/RX Hook 脚本内容和类型 |

配置文件位于可执行文件同目录下，可手动编辑或备份。

---

## 9. 开发模式运行

### 9.1 启动前端

```powershell
cd src/ui
npm install
npm run dev
```

等待输出 `Local: http://localhost:5173/`

### 9.2 启动后端

```powershell
cd src/tauri
cargo run
```

> **注意**：必须通过 Tauri 窗口使用，浏览器直接访问 localhost 无法使用串口功能

### 9.3 构建发布版本

```powershell
cd src/ui
npm run build

cd ../tauri
cargo build --release
```

---

## 10. 常见问题

### Q: 端口列表是空的

- 检查是否有串口设备连接
- 点击刷新按钮重新扫描
- 确认设备管理器中能看到串口

### Q: 连接失败

- 确认端口没有被其他软件占用
- 检查串口参数是否正确
- 尝试降低波特率

### Q: 数据显示乱码

- 检查波特率设置是否与设备匹配
- 尝试切换 ASCII/HEX 显示模式
- 确认数据位、停止位、校验位设置正确

### Q: 端口共享提示 "com0com 未安装"

- 下载并安装 com0com 驱动
- 安装后重启 SerialMaster

### Q: 外部脚本执行失败

- 确认命令路径正确
- 检查脚本文件是否存在
- 确保 Python/Node.js 已添加到系统 PATH
