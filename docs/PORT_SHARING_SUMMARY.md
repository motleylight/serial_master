# 端口共享与 UI 重构回顾 (Port Sharing & UI Refactoring Retrospective)

本文档记录了在开发 "端口共享 (Port Sharing)" 功能及重构相关 UI 过程中遇到的主要困境、技术决策及最终解决方案。

## 1. 拓扑图设计的演进 (Topology Diagram Evolution)

### 困境 (Dilemma)
用户需要一个直观的图表来理解端口共享的数据流向（物理端口 -> SerialMaster -> 虚拟端口 -> 第三方应用）。
- **初期尝试**: 使用复杂的 SVG 图标和连线，试图模拟真实的物理连接。
- **问题**:
    - **视觉杂乱**: 图标过多分散了注意力，不够现代。
    - **对齐困难**: 在动态增加虚拟端口时，SVG 的连线坐标计算复杂，导致连接线经常发生错位（如未对齐到文本框中心）。
    - **信息过载**: 过多的 "透传" (Transparent) 标签和箭头让图表显得臃肿。

### 解决方案 (Solution)
我们经历了三个版本的迭代，最终确定了 **"极简对称 SVG (Symmetrical Minimalist SVG)"** 方案：
1.  **结构**: 采用 Flexbox/Grid 布局确立节点的骨架位置，仅使用 SVG 绘制连接线。这结合了 HTML 布局的灵活性和 SVG 绘图的平滑性。
2.  **视觉风格**:
    - **去图标化**: 移除显式图标，改用圆角矩形 Badge (胶囊) 代表节点 (SerialMaster / com0com)。
    - **贝塞尔曲线**: 使用三次贝塞尔曲线 (Cubic Bezier) 代替折线，视觉更流畅。
    - **对称性**: 强制让 "物理端口" 节点相对于右侧的 "虚拟端口列表" 垂直居中，无论右侧有多少个端口。
3.  **技术实现**:
    - 使用 `viewBox="0 0 100 100"` 和 `preserveAspectRatio="none"` 让 SVG 坐标系统自适应容器高度。
    - 动态计算 Y 轴百分比坐标 (e.g., `50%` to `yTarget`) 确保连线永远精准对齐节点中心。

## 2. 性能优化 (Performance Optimization)

### 困境 (Dilemma)
当点击 "Share Port" 按钮打开弹窗时，界面会出现约 1-2 秒的明显卡顿，导致 "Processing..." 状态滞留过久，用户体验极差。

### 原因分析
通过代码审查发现，`PortSharingDialog` 在每次渲染或状态更新时，都会重新调用 `SerialService.getPorts()`。
- Windows 下的串口扫描是一个高 IO 操作，耗时较长（尤其是有蓝牙串口时）。
- 弹窗的 `useEffect` 同时执行了 **“获取所有物理端口”** (扫描) 和 **“获取共享状态”** (com0com 查询) 两个操作，UI 被阻塞。

### 解决方案 (Solution)
**分离数据加载策略 (Decoupled Data Loading)**：
1.  **静态数据 (loadPorts)**: 仅在弹窗**首次打开**时执行一次物理端口扫描。
2.  **动态数据 (loadStatus)**: 共享状态的查询（com0com）非常快，可以独立频繁调用。
3.  **结果**: 弹窗打开后立即显示框架，端口列表异步加载，操作共享开关时不再触发全量端口扫描，界面响应达到毫秒级。

## 3. 按钮与状态 UI 的统一 (Unified "Pill" Button Design)

### 困境 (Dilemma)
Control Panel 中的 "Scripts" 按钮和 "Share Port" 按钮风格不统一，且激活状态 (Active State) 的表现不佳：
- **突兀**: 激活后变为纯色实心按钮 (Solid Blue/Purple)，在浅色工具栏上显得过于抢眼且不协调。
- **高度抖动**: 添加 "TX/RX" 等状态标签后，导致工具栏高度被撑开，产生布局抖动。
- **操作繁琐**: 用户想要关闭功能时，不仅要找按钮，还缺乏直观的 "关闭" 入口。

### 解决方案 (Solution)
设计了一套统一的 **"状态胶囊 (Status Pill)"** UI 规范，应用于所有具有 "开关/状态" 性质的功能按钮：

#### 设计规范
*   **未激活 (Inactive)**: 标准白色按钮，灰色边框，融入背景。
*   **激活 (Active)**: 变身为一个**包含状态和操作的容器 (Container)**，高度固定为 `h-7` (28px)。

| 特征 | Scripts (脚本) | Share Port (端口共享) |
| :--- | :--- | :--- |
| **主色调** | **蓝色 (Blue)** | **紫色 (Purple)** |
| **容器样式** | `bg-blue-50` + `border-blue-200` | `bg-purple-50` + `border-purple-200` |
| **左侧 (Label)** | "Script" 文字 | "Sharing" + 图标 |
| **中间 (Info)** | TX/RX 动态指示灯 | 共享的端口号列表 (e.g., "COM10, ...") |
| **右侧 (Action)** | **停止按钮 (X)** | **停止按钮 (X)** |

#### 优势
1.  **视觉降噪**: 使用浅色背景 (`bg-50`) 代替深色背景，保留了强调色但不再刺眼。
2.  **集成控制**: 用户可以直接点击胶囊右侧的 "X" 快速关闭功能，无需进入二级菜单。
3.  **布局稳定**: 严格限制内部元素高度和间距 (`gap-[1px]`)，确保在任何状态下都不会撑开工具栏高度。
