# 脚本模块重构与外部 Hook 指南

## 协议变更
1. **移除 (Removed)**: 内嵌的 RustPython 引擎。
2. **新增 (Added)**: 前端 JavaScript 脚本支持。
3. **新增 (Added)**: 外部程序管道 (External Pipe) 支持。

## JavaScript 脚本
脚本现在使用 JavaScript 编写，并直接在前端 (UI 进程) 中运行。

### Tx Hook (发送前钩子)
- **上下文**: `data` (数字数组, 例如 `[0x01, 0x02]`)。
- **动作**: 原地修改 `data` 数组，或者返回一个新的数组。
- **时机**: 在数据发送到后端串口 *之前* 执行。

### Rx Hook (接收/显示前钩子)
- **上下文**: `data` (数字数组)。
- **动作**: 修改 `data` 以进行过滤或转换。如果返回空数组，则是丢弃该数据包。
- **时机**: 从后端接收到数据后，在显示到终端窗口 *之前* 执行。

## 外部命令 (External Command)
允许通过外部可执行文件（通过标准输入 stdin -> 标准输出 stdout）来处理串口数据。

### 配置方法
- 在脚本编辑器中默认选择 **External Command** 模式。
- 输入完整的命令行 (例如 `python my_filter.py` 或 `node processor.js`)。

### 行为逻辑
- **Tx Hook**:
    - SerialMaster 启动外部进程。
    - 将待发送的数据写入进程的 `stdin`。
    - 从进程的 `stdout` 读取处理后的数据。
    - 将结果发送到物理串口。
- **Rx Hook**:
    - SerialMaster 从物理串口收到数据。
    - 启动外部进程。
    - 将收到的数据写入进程的 `stdin`。
    - 从进程的 `stdout` 读取处理后的数据。
    - 将结果发送给前端显示。

### 注意事项
- 如果外部进程失败 (非零退出码)，Tx 操作将失败，Rx 操作会记录错误。
- **每一个** 数据包都会重新启动一个新的进程实例。（因此请确保您的外部脚本启动速度够快，或者仅用于低频调试）。

## 互斥逻辑
- 启用 **JavaScript** 模式会清除任何已设置的 **External** Hooks。
- 启用 **External** 模式会清除任何 **JavaScript** 脚本。

## 界面操作
- **启动/应用**: 点击编辑器中的蓝色 **Apply** 按钮激活当前脚本。主界面状态栏会显示对应的指示器（如 `TX:JS`, `RX:EXT`）。
- **停止**:
    - 在主界面点击状态指示器旁的红色 **X** 按钮即可一键停止所有脚本。
    - 或者再次打开编辑器，点击红色的 **Stop** 按钮。
- **默认设置**: 编辑器现在默认优先展示 **External Command** 模式和 **Rx Hook** 标签页，以符合常见使用场景。
