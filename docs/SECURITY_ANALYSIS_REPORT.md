# SerialUtil 安全分析报告

**日期**: 2026-01-18  
**分析对象**: SerialUtil 源代码  
**严重程度分级**: 严重 (Critical) / 高 (High) / 中 (Medium) / 低 (Low)

## 1. 概述 (Overview)

经过对 SerialUtil 代码库的全面分析，我们发现软件整体架构清晰，采用了 Tauri (Rust) + React 前后端分离的模式。前端通过 IPC 与后端通信，大部分敏感操作集中在后端。

本次分析主要关注输入处理、脚本执行环境及外部程序交互。我们发现了 **1 个严重漏洞** 和 **1 个高危漏洞**，主要集中在后端特权服务和命令执行模块。前端脚本环境相对安全，但仍需加强防范。

## 2. 漏洞详情 (Detailed Findings)

### 2.1 [严重] 本地提权漏洞 (Local Privilege Escalation)
**位置**: `src/core/admin_service.rs`  
**描述**: 
SerialUtil 包含一个 `AdminService`，监听本地 TCP 端口 `56789`，用于执行需要管理员权限的操作（主要是 `setupc.exe` 配置 com0com）。
该服务存在以下严重问题：
1.  **无身份验证**: 任何运行在本地的程序（包括低权限恶意软件）都可以连接到此端口。
2.  **未授权命令执行**: 服务接收 JSON 指令直接执行 `setupc.exe`，攻击者可以利用此服务随意修改、删除系统虚拟串口，甚至可能利用 `setupc` 自身的潜在漏洞破坏系统驱动配置。
3.  **服务运行权限**: 该服务不仅监听端口，而且通常需要以管理员权限运行才能配置驱动。这意味着它是攻击者从普通用户权限跳跃到管理员权限的理想跳板。

**利用场景**:
攻击者编写一个普通的恶意脚本，连接 `127.0.0.1:56789`，发送 `{"ExecuteSetupc": ...}` 指令，即可在无 UAC 提示的情况下修改系统驱动配置。

### 2.2 [高] 命令注入漏洞 (Command Injection)
**位置**: `src/tauri/src/scripting.rs`
**描述**:
后端脚本执行模块使用 `std::process::Command` 调用外部程序。
- Windows 下代码: `let (program, args) = ("cmd", vec!["/C", cmd_line]);`
- Linux/Mac 下代码: `sh -c cmd_line`

代码直接将 `cmd_line` 拼接传入 shell 执行。如果 `cmd_line` 内容由用户输入且包含特殊字符（如 `&`, `|`, `;`），则会导致命令注入。
虽然 `cmd_line` 来源于配置文件或用户设置，看似“用户自己对自己负责”，但存在以下风险：
1.  **配置文件攻击**: 攻击者可以诱导用户加载恶意的 `config.yaml` 或项目文件，其中包含恶意的 `pre_send` 脚本字符串（例如 `calc.exe & format c:`）。用户一旦打开软件并连接串口，恶意命令即刻执行。
2.  **UI 隐蔽性**: 恶意命令可以隐藏在正常的脚本命令之后，用户难以察觉。

### 2.3 [中] 外部脚本资源耗尽 (Resource Exhaustion)
**位置**: `src/tauri/src/scripting.rs`
**描述**:
外部脚本是通过同步阻塞的方式调用的 (`child.wait_with_output()`)。如果用户（或攻击者配置的）外部脚本陷入死循环或长时间阻塞，会导致后端相关线程挂起。虽然 Tauri 的异步命令处理可能不会完全卡死 UI，但会消耗系统资源并阻止后续串口数据的发送/接收。

### 2.4 [低] 前端脚本执行风险
**位置**: `src/ui/src/hooks/useScriptRunner.ts`
**描述**:
前端使用了 Web Worker 和 `AsyncFunction` 来执行用户定义的 JavaScript。
- **优点**: 将脚本隔离在 Worker 中，无法直接访问 DOM 或 Tauri IPC（`__TAURI__` 全局变量），大大降低了 XSS 攻击面。
- **风险**: 脚本依然可以执行死循环消耗 CPU（虽然可以通过 UI 终止 Worker）。如果脚本逻辑复杂，可能导致浏览器页面卡顿。目前没有限制 Worker 的内存使用，极端情况下可能导致页面崩溃。

## 3. 修复建议 (Recommendations)

### 3.1 修复 AdminService
1.  **增加认证机制**: 在启动 `AdminService` 时，由父进程生成一个随机 Token 通过参数传递给服务。服务在处理任何请求前，必须校验请求中是否包含正确的 Token。
2.  **限制监听范围**: 确保仅监听 `127.0.0.1`（目前代码已做到）。
3.  **最小权限原则**: 如果可能，尽量避免一直运行该服务，仅在通过 UAC 提权后临时运行。

### 3.2 修复命令注入
1.  **避免 Shell 执行**: 尽量不要使用 `cmd /C` 或 `sh -c` 来运行外部脚本。
2.  **参数化执行**: 修改配置结构，将“程序路径”和“参数列表”分开存储。
    ```rust
    // 推荐方式
    Command::new(program_path).args(arguments_vec)
    ```
    这样即使用户输入特殊字符，也会被视为普通参数，而不是 Shell 元字符。
3.  **用户确认**: 当加载包含外部脚本的配置文件时，并在第一次执行前，弹出警告框告知用户即将执行的命令，并请求确认。

### 3.3 增强前端沙箱
1.  **超时控制**: 在 Worker 中增加执行超时机制，如果是单纯的数据处理函数，不应运行超过几百毫秒。
2.  **资源限制**: 虽然浏览器对 Worker 有限流，但建议在文档中明确告知用户脚本的运行限制。

## 4. 结论
SerialUtil 功能强大，但在安全性方面（特别是本地权限交互和配置加载）存在典型漏洞。建议在下一个版本中优先修复 `AdminService` 的认证问题，并重构外部脚本的调用方式以防止注入攻击。
